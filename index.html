<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="RoyalDiary">
    
    <title>Royal Diary</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@600&family=Noto+Serif+TC:wght@600&display=swap');
        
        :root {
            --ribbon-pink: #F4C2C2;
            --deep-rose: #D47381;
            --gingham: #ffe4e9;
            --glass-bg: rgba(255, 252, 249, 0.7);
            --glass-border: rgba(255, 255, 255, 0.8);
        }

        body {
            margin: 0; padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom);
            background-color: #fff;
            background-image: linear-gradient(90deg, var(--gingham) 50%, transparent 50%),
                              linear-gradient(var(--gingham) 50%, transparent 50%);
            background-size: 35px 35px;
            font-family: 'Noto Serif TC', serif;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; color: #5a4a4a;
            box-sizing: border-box; overflow: hidden;
            /* é˜²æ­¢æ‰‹æ©Ÿæ‹‰å‹•å›å½ˆæ•ˆæœ */
            overscroll-behavior-y: none;
        }

        .main-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            width: 100%; max-width: 480px; height: 100%;
            padding: 20px; border-radius: 35px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 15px 35px rgba(212, 115, 129, 0.1);
            box-sizing: border-box; display: flex; flex-direction: column;
        }

        h1 { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: var(--deep-rose); margin: 0; text-align: center; }
        .quote-box { text-align: center; font-size: 0.8rem; color: #888; font-style: italic; margin-bottom: 10px; min-height: 1.2rem; }

        .fixed-top { flex-shrink: 0; }

        .status-box {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 20px; padding: 15px; margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.8); text-align: center;
        }
        
        .progress-bar-bg { width: 100%; height: 12px; background: rgba(255, 255, 255, 0.6); border-radius: 50px; overflow: hidden; margin: 8px 0; }
        .progress-bar-fill { height: 100%; background: linear-gradient(90deg, #FFD1DC, var(--deep-rose)); width: 0%; transition: width 1.2s ease; }

        .summary-row {
            display: flex; justify-content: space-around;
            margin-top: 10px; padding-top: 10px;
            border-top: 1px dashed rgba(212, 115, 129, 0.2);
            font-size: 0.8rem;
        }
        .summary-item b { display: block; font-size: 1rem; color: var(--deep-rose); }

        .date-container { text-align: center; margin-bottom: 10px; }
        #mainDate { border: 1.5px solid var(--ribbon-pink); border-radius: 10px; padding: 5px; font-family: inherit; color: var(--deep-rose); background: white; -webkit-appearance: none; }

        .entry-row {
            background: rgba(255, 255, 255, 0.6); padding: 10px;
            border-radius: 18px; margin-bottom: 10px; border: 1px solid rgba(255, 255, 255, 0.9);
            display: flex; flex-direction: column; gap: 5px;
        }
        .row-main { display: flex; align-items: center; gap: 8px; }
        .type-select { border: 1.5px solid var(--ribbon-pink); border-radius: 10px; padding: 3px; color: var(--deep-rose); font-size: 0.8rem; outline: none; background: #fff; }
        .input-note { flex: 1; background: transparent; border: none; border-bottom: 1.5px solid var(--ribbon-pink); outline: none; font-size: 1rem; }
        
        .row-amount { display: flex; justify-content: flex-end; align-items: center; gap: 5px; }
        .amount-symbol { color: var(--deep-rose); font-weight: bold; }
        .input-amount { width: 85px; background: transparent; border: none; border-bottom: 1.5px solid var(--ribbon-pink); outline: none; text-align: right; font-weight: bold; color: var(--deep-rose); font-size: 1.2rem; }
        
        button { transition: all 0.2s; cursor: pointer; font-family: inherit; -webkit-tap-highlight-color: transparent; }
        button:active { transform: scale(0.95); opacity: 0.8; }

        .btn-add { background: white; border: 1.5px dashed var(--deep-rose); color: var(--deep-rose); width: 100%; padding: 8px; border-radius: 15px; margin-bottom: 10px; font-weight: bold; }
        .btn-save { background: linear-gradient(135deg, #FFB7B7, var(--deep-rose)); color: white; border: none; width: 100%; padding: 12px; border-radius: 50px; font-weight: 800; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(212, 115, 129, 0.2); }

        .history-section { flex: 1; overflow: hidden; display: flex; flex-direction: column; border-top: 1px solid rgba(212, 115, 129, 0.1); margin-top: 15px; padding-top: 5px; }
        .history-scroll-area { overflow-y: auto; flex: 1; -webkit-overflow-scrolling: touch; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.5); }
        .amt-in { color: var(--deep-rose); font-weight: bold; }
        .amt-out { color: #888; font-weight: bold; }

        /* è¨­å®šé¢æ¿é‡å°æ‰‹æ©Ÿå„ªåŒ– */
        .settings-panel { 
            display: none; background: white; border-radius: 25px; padding: 20px; 
            position: absolute; z-index: 100; width: 92%; left: 4%; top: 45px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border: 1px solid var(--ribbon-pink);
            max-height: 80vh; overflow-y: auto; box-sizing: border-box;
        }
        .recurring-item { background: #fffcfc; border: 1px solid var(--ribbon-pink); border-radius: 12px; padding: 10px; margin-top: 8px; font-size: 0.8rem; position: relative; }
    </style>
</head>
<body>

    <div class="main-card">
        <div class="fixed-top">
            <div style="display:flex; justify-content: space-between; align-items: center; padding: 0 5px;">
                <span style="font-size: 1.5rem;">ğŸ€</span>
                <button onclick="toggleSettings()" style="background:none; border:none; color:var(--deep-rose); font-size: 1.4rem;">âš™ï¸</button>
            </div>

            <div id="settingsPanel" class="settings-panel">
                <p style="font-weight: bold; color: var(--deep-rose); text-align: center; margin:0 0 15px 0;">âœ¨ çš‡å®¶åƒæ•¸è¨­å®š âœ¨</p>
                <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
                    <input type="text" id="wishInput" placeholder="é¡˜æœ›åç¨±" style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                    <input type="number" id="goalInput" placeholder="ç›®æ¨™é‡‘é¡" style="padding:10px; border-radius:10px; border:1px solid #ddd;">
                </div>
                <p style="font-weight: bold; color: var(--deep-rose); font-size: 0.85rem; margin: 10px 0 5px;">ğŸ”„ å›ºå®šå¾ªç’°æ”¶æ”¯</p>
                <div id="recurringList"></div>
                <div style="background: var(--gingham); padding: 10px; border-radius: 15px; margin-top: 10px; display: flex; flex-direction: column; gap: 5px;">
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="recNote" placeholder="åç¨±" style="flex:2; padding:8px; border-radius:8px; border:none;">
                        <input type="number" id="recDay" placeholder="æ—¥æœŸ" style="flex:1; padding:8px; border-radius:8px; border:none;">
                    </div>
                    <div style="display:flex; gap:5px;">
                        <select id="recType" style="flex:1; border-radius:8px; border:none; background:white; font-size:0.8rem;"><option value="in">ğŸ’– å­˜å…¥</option><option value="out">ğŸ’¸ æ”¯å‡º</option></select>
                        <input type="number" id="recAmt" placeholder="é‡‘é¡" style="flex:1; padding:8px; border-radius:8px; border:none;">
                        <button onclick="addRecurring()" style="background:var(--deep-rose); color:white; border:none; border-radius:8px; padding:0 15px;">ï¼‹</button>
                    </div>
                </div>
                <button onclick="saveSettings()" class="btn-save" style="margin-top:20px;">å„²å­˜è¨­å®š</button>
            </div>

            <h1>Royal Diary</h1>
            <div id="dailyQuote" class="quote-box"></div>

            <div class="status-box">
                <p id="wishTitle" style="font-weight: 800; color: var(--deep-rose); margin:0; font-size: 0.95rem;">æˆ‘çš„ç²¾ç·»è¨ˆç•«</p>
                <div class="progress-bar-bg"><div id="progressFill" class="progress-bar-fill"></div></div>
                <p style="margin:0; font-size:0.85rem; font-weight: 600;">
                    é”æˆ <span id="percentText" style="color:var(--deep-rose);">0</span>% ($<span id="currentText">0</span> / $<span id="goalText">0</span>)
                </p>
                <div class="summary-row">
                    <div class="summary-item">ç´¯ç©å­˜å…¥<b id="totalIn">$0</b></div>
                    <div class="summary-item">ç´¯ç©æ”¯å‡º<b id="totalOut">$0</b></div>
                </div>
            </div>

            <div class="date-container"><input type="date" id="mainDate"></div>

            <div id="inputArea">
                <div class="entry-row">
                    <div class="row-main">
                        <select class="type-select"><option value="in">ğŸ’– å­˜å…¥</option><option value="out">ğŸ’¸ æ”¯å‡º</option></select>
                        <input type="text" class="input-note" placeholder="è¨˜éŒ„ä¸€é»å°ç¢ºå¹¸...">
                        <button style="background:none; border:none; color:#FFB7B7; font-size:1.4rem;" onclick="removeRow(this)">Ã—</button>
                    </div>
                    <div class="row-amount">
                        <span class="amount-symbol">$</span>
                        <input type="number" class="input-amount" placeholder="0" inputmode="decimal">
                    </div>
                </div>
            </div>
            
            <button class="btn-add" onclick="addNewRow()">ï¼‹ å¢åŠ æ˜ç´°</button>
            <button class="btn-save" onclick="saveEntries()">å¯«å…¥çš‡å®¶ç´€éŒ„ âœ¨</button>
        </div>

        <div class="history-section">
            <div id="historyList" class="history-scroll-area"></div>
        </div>
        <button onclick="resetData()" style="color:#eee; border:none; background:none; font-size:9px; margin:5px 0; opacity: 0.5;">RESET DATA</button>
    </div>

    <script>
        const quotes = ["æ¯ä¸€ç­†å°å°çš„ç´¯ç©ï¼Œéƒ½æ˜¯å¦³æœªä¾†çš„åº•æ°£ã€‚", "å„ªé›…çš„ç”Ÿæ´»ï¼Œå¾å­¸æœƒç†è²¡é–‹å§‹ã€‚", "é¡˜æœ›ä¹‹æ‰€ä»¥èƒ½å¯¦ç¾ï¼Œæ˜¯å› ç‚ºå¦³å¾æœªåœæ­¢åŠªåŠ›ã€‚", "æ¯ä¸€ä»½å„²è“„ï¼Œéƒ½æ˜¯å°å¤¢æƒ³çš„çŒæº‰ã€‚"];
        let goal = parseFloat(localStorage.getItem('royal_goal')) || 5000;
        let wish = localStorage.getItem('royal_wish') || "æˆ‘çš„ç²¾ç·»è¨ˆç•«";
        let history = JSON.parse(localStorage.getItem('royal_history')) || [];
        let recurring = JSON.parse(localStorage.getItem('royal_recurring')) || [];
        let lastCheck = localStorage.getItem('royal_last_check') || "";

        window.onload = function() {
            document.getElementById('mainDate').value = new Date().toISOString().split('T')[0];
            checkRecurring();
            updateQuote();
            updateUI();
            renderRecurringList();
        };

        function checkRecurring() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
            if (lastCheck === todayStr) return;
            let autoAdded = false;
            recurring.forEach(item => {
                if (today.getDate() == item.day) {
                    const id = `auto-${todayStr}-${item.note}`;
                    if (!history.find(h => h.id === id)) {
                        history.unshift({ id: id, date: todayStr.replace(/-/g, '.'), note: `ğŸ”„ ${item.note}`, amount: item.type === 'in' ? item.amount : -item.amount, type: item.type, ts: today.getTime() });
                        autoAdded = true;
                    }
                }
            });
            if (autoAdded) {
                localStorage.setItem('royal_history', JSON.stringify(history));
                alert("âœ¨ çš‡å®¶ç®¡å®¶ï¼šå·²è‡ªå‹•è£œä¸Šä»Šæ—¥å›ºå®šæ”¶æ”¯ï¼");
            }
            localStorage.setItem('royal_last_check', todayStr);
        }

        function toggleSettings() {
            const p = document.getElementById('settingsPanel');
            p.style.display = (p.style.display === 'block') ? 'none' : 'block';
            if(p.style.display === 'block') {
                document.getElementById('wishInput').value = wish;
                document.getElementById('goalInput').value = goal;
            }
        }

        function saveSettings() {
            goal = parseFloat(document.getElementById('goalInput').value) || goal;
            wish = document.getElementById('wishInput').value || wish;
            localStorage.setItem('royal_goal', goal);
            localStorage.setItem('royal_wish', wish);
            localStorage.setItem('royal_recurring', JSON.stringify(recurring));
            updateUI();
            toggleSettings();
        }

        function addRecurring() {
            const note = document.getElementById('recNote').value;
            const day = parseInt(document.getElementById('recDay').value);
            const amt = parseFloat(document.getElementById('recAmt').value);
            const type = document.getElementById('recType').value;
            if (note && day >= 1 && day <= 31 && amt > 0) {
                recurring.push({ note, day, amount: amt, type });
                document.getElementById('recNote').value = '';
                document.getElementById('recDay').value = '';
                document.getElementById('recAmt').value = '';
                renderRecurringList();
            }
        }

        function renderRecurringList() {
            const list = document.getElementById('recurringList');
            list.innerHTML = recurring.map((item, index) => `
                <div class="recurring-item">
                    <b>æ¯æœˆ ${item.day} è™Ÿ</b> - ${item.note} 
                    <span style="color:${item.type==='in'?'#D47381':'#888'}">($${item.amount.toLocaleString()})</span>
                    <button onclick="removeRecurring(${index})" style="position:absolute; right:10px; top:8px; border:none; background:none; color:#ffb7b7; font-size:1.2rem;">Ã—</button>
                </div>
            `).join('');
        }

        function removeRecurring(index) { recurring.splice(index, 1); renderRecurringList(); }
        function updateQuote() { document.getElementById('dailyQuote').innerText = `âœ¨ ${quotes[Math.floor(Math.random() * quotes.length)]}`; }

        function addNewRow() {
            const div = document.createElement('div');
            div.className = 'entry-row';
            div.innerHTML = `<div class="row-main"><select class="type-select"><option value="in">ğŸ’– å­˜å…¥</option><option value="out">ğŸ’¸ æ”¯å‡º</option></select><input type="text" class="input-note" placeholder="è¨˜éŒ„ä¸€é»å°ç¢ºå¹¸..."><button style="background:none; border:none; color:#FFB7B7; font-size:1.4rem;" onclick="removeRow(this)">Ã—</button></div><div class="row-amount"><span class="amount-symbol">$</span><input type="number" class="input-amount" placeholder="0" inputmode="decimal"></div>`;
            document.getElementById('inputArea').appendChild(div);
        }

        function removeRow(btn) { if (document.querySelectorAll('.entry-row').length > 1) btn.closest('.entry-row').remove(); }

        function saveEntries() {
            const rows = document.querySelectorAll('.entry-row');
            const d = new Date(document.getElementById('mainDate').value);
            const dateStr = `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
            let hasData = false;
            rows.forEach(row => {
                const type = row.querySelector('.type-select').value;
                const note = row.querySelector('.input-note').value || (type === 'in' ? "å­˜å…¥" : "æ”¯å‡º");
                const amt = parseFloat(row.querySelector('.input-amount').value);
                if (!isNaN(amt) && amt > 0) {
                    history.unshift({ id: Date.now() + Math.random(), date: dateStr, note: note, amount: type === 'in' ? amt : -amt, type: type, ts: d.getTime() });
                    hasData = true;
                }
            });
            if(hasData) {
                history.sort((a, b) => b.ts - a.ts);
                localStorage.setItem('royal_history', JSON.stringify(history));
                document.getElementById('inputArea').innerHTML = `<div class="entry-row"><div class="row-main"><select class="type-select"><option value="in">ğŸ’– å­˜å…¥</option><option value="out">ğŸ’¸ æ”¯å‡º</option></select><input type="text" class="input-note" placeholder="è¨˜éŒ„ä¸€é»å°ç¢ºå¹¸..."><button style="background:none; border:none; color:#FFB7B7; font-size:1.4rem;" onclick="removeRow(this)">Ã—</button></div><div class="row-amount"><span class="amount-symbol">$</span><input type="number" class="input-amount" placeholder="0" inputmode="decimal"></div></div>`;
                updateUI();
            }
        }

        function updateUI() {
            const totalIn = history.filter(h => h.type === 'in').reduce((s, i) => s + Math.abs(i.amount), 0);
            const totalOut = history.filter(h => h.type === 'out').reduce((s, i) => s + Math.abs(i.amount), 0);
            const balance = Math.max(0, totalIn - totalOut);
            document.getElementById('totalIn').innerText = `$${totalIn.toLocaleString()}`;
            document.getElementById('totalOut').innerText = `$${totalOut.toLocaleString()}`;
            document.getElementById('wishTitle').innerText = `âœ¨ ${wish} âœ¨`;
            document.getElementById('currentText').innerText = Math.floor(balance).toLocaleString();
            document.getElementById('goalText').innerText = goal.toLocaleString();
            let percent = Math.min((balance / goal) * 100, 100);
            document.getElementById('percentText').innerText = Math.floor(percent);
            document.getElementById('progressFill').style.width = percent + "%";
            const list = document.getElementById('historyList');
            list.innerHTML = history.map(h => `
                <div class="history-item">
                    <div><span style="font-size:0.75rem; color:#999;">${h.date}</span><br><b>${h.note}</b></div>
                    <div style="display:flex; align-items:center;">
                        <span class="${h.type === 'in' ? 'amt-in' : 'amt-out'}">${h.type === 'in' ? '+' : ''}${h.amount.toLocaleString()}</span>
                        <button onclick="deleteItem('${h.id}')" style="background:none; border:none; color:#ddd; font-size:1.5rem; margin-left:10px; padding: 5px;">Ã—</button>
                    </div>
                </div>
            `).join('') || '<p style="text-align:center; color:#ccc; margin-top:20px; font-size:0.9rem;">é–‹å§‹å¦³çš„åœ“å¤¢ä¹‹æ—…...</p>';
        }

        function deleteItem(id) {
            if(confirm("ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) {
                history = history.filter(h => h.id != id);
                localStorage.setItem('royal_history', JSON.stringify(history));
                updateUI();
            }
        }

        function resetData() { if(confirm("é‡ç½®æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
